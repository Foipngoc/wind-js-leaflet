<!-- https://github.com/danwild/wind-js-leaflet -->

<!doctype html>
<html>
<head>
	<title>WindJS (ESRI) Leaflet Demo</title>
	<meta charset="utf-8">
</head>
<body>

<div id="map"></div>

<!--leaflet-->
<link rel="stylesheet" href="leaflet/leaflet.css" />
<script src="leaflet/leaflet.js"></script>
<script src="resource/L.CanvasOverlay.js"></script>

<!--other-->
<link rel="stylesheet" href="resource/demo.css" />
<script src="resource/windy.js"></script>

<script src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>

<script>

    // try live service if running, or use static
    $.ajax({
//		url: 'http://localhost:7000/latest',
        url: 'http://nawth.io:7000/latest',
        success: function(data){
			console.log(data);
            init(data);
        },
        error: function( ){
            $.getJSON('resource/static.json', function (data) {
                init(data);
            });
        },
        timeout: 2000
    });

	function init(data){

		console.log('data');
		console.log(data);

		var timer = null;
		var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, ' +
			'AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
		});

		var Esri_DarkGreyCanvas = L.tileLayer(
			"http://{s}.sm.mapstack.stamen.com/" +
			"(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/" +
			"{z}/{x}/{y}.png",
			{
				attribution: 'Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, ' +
				'NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community'
			}
		);

		var baseLayers = {
			"Satellite": Esri_WorldImagery,
			"Blank Canvas": Esri_DarkGreyCanvas
		};

		var map = L.map('map', {
			layers: [
				Esri_WorldImagery,
				Esri_DarkGreyCanvas
			]
		});

		L.control.layers(baseLayers).addTo(map);
		map.setView([50.00, 14.44], 3);



		//Add CanvasLayer to the map
		canvasOverlay = L.canvasOverlay()
				.drawing(redraw)
				.addTo(map);

		//windy object
		windy = new Windy({canvas: canvasOverlay.canvas(), data: data});

		//prepare context global var
		context = canvasOverlay.canvas().getContext('2d');

		//start drawing wind map
		function redraw(overlay, params) {

			if( timer )
				window.clearTimeout( timer );

			timer = setTimeout(function() { //showing wind is delayed

				var bounds = map.getBounds();
				var size = map.getSize();

				// fade in..
//                context.rect(0,0,3000,3000);
//                context.fillStyle = "grey";
//                context.fill();

				windy.start( [[0,0],[size.x, size.y]], size.x, size.y,
						[[bounds._southWest.lng, bounds._southWest.lat ],[bounds._northEast.lng, bounds._northEast.lat]] );
			},750)

		}

		// clear canvas and stop animation
		function clearWind() {
			windy.stop();
			context.clearRect(0, 0, 3000, 3000);
		}

		map.on('dragstart', function() { windy.stop(); });
		map.on('zoomstart', function() { clearWind() });
		map.on('resize', function() { clearWind() });
	}

</script>
</body>
</html>
