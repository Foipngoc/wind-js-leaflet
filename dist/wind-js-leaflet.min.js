"use strict";L.CanvasOverlay=L.Class.extend({initialize:function(n,t){this._userDrawFunc=n,L.setOptions(this,t)},drawing:function(n){return this._userDrawFunc=n,this},params:function(n){return L.setOptions(this,n),this},canvas:function(){return this._canvas},redraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(n){this._map=n,this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer");var t=this._map.getSize();this._canvas.width=t.x,this._canvas.height=t.y;var e=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(e?"animated":"hide")),n._panes.overlayPane.appendChild(this._canvas),n.on("moveend",this._reset,this),n.on("resize",this._resize,this),n.options.zoomAnimation&&L.Browser.any3d&&n.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(n){n.getPanes().overlayPane.removeChild(this._canvas),n.off("moveend",this._reset,this),n.off("resize",this._resize,this),n.options.zoomAnimation&&n.off("zoomanim",this._animateZoom,this)},addTo:function(n){return n.addLayer(this),this},_resize:function(n){this._canvas.width=n.newSize.x,this._canvas.height=n.newSize.y},_reset:function(){var n=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,n),this._redraw()},_redraw:function(){var n=this._map.getSize(),t=this._map.getBounds(),e=180*n.x/(20037508.34*(t.getEast()-t.getWest())),i=this._map.getZoom();this._userDrawFunc&&this._userDrawFunc(this,{canvas:this._canvas,bounds:t,size:n,zoomScale:e,zoom:i,options:this.options}),this._frame=null},_animateZoom:function(n){var t=this._map.getZoomScale(n.zoom),e=this._map._getCenterOffset(n.center)._multiplyBy(-t).subtract(this._map._getMapPanePos());this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(e)+" scale("+t+")"}}),L.canvasOverlay=function(n,t){return new L.CanvasOverlay(n,t)};var Windy=function(n){var t,e,i=.005*(Math.pow(window.devicePixelRatio,1/3)||1),o=261.15,a=317.15,r=90,s=1,l=.005,d=Math.pow(window.devicePixelRatio,1/3)||1.6,u=15,c=1e3/u,h=[NaN,NaN,null],p=function(n,t,e,i,o,a){var r=1-n,s=1-t,l=r*s,d=n*s,u=r*t,c=n*t,h=e[0]*l+i[0]*d+o[0]*u+a[0]*c,p=e[1]*l+i[1]*d+o[1]*u+a[1]*c,m=e[2]*l+i[2]*d+o[2]*u+a[2]*c;return[h,p,m]},m=function(n,t,e){var i=n.data,o=t.data;return{header:n.header,data:function(n){return[i[n],o[n],e.data[n]]},interpolate:p}},f=function(n){var t=null,e=null,i=null,o=null;return n.forEach(function(n){switch(n.header.parameterCategory+","+n.header.parameterNumber){case"2,2":t=n;break;case"2,3":e=n;break;case"0,0":i=n;break;default:o=n}}),m(t,e,i)},v=function(n,t){function e(n,t){var e,o=g(n-a,360)/s,d=(r-t)/l,u=Math.floor(o),c=u+1,p=Math.floor(d),m=p+1;if(e=h[p]){var f=e[u],v=e[c];if(w(f)&&w(v)&&(e=h[m])){var S=e[u],W=e[c];if(w(S)&&w(W))return i.interpolate(o-u,d-p,f,v,S,W)}}return null}var i=f(n),o=i.header,a=o.lo1,r=o.la1,s=o.dx,l=o.dy,d=o.nx,u=o.ny,c=new Date(o.refTime);c.setHours(c.getHours()+o.forecastTime);for(var h=[],p=0,m=Math.floor(d*s)>=360,v=0;v<u;v++){for(var S=[],W=0;W<d;W++,p++)S[W]=i.data(p);m&&S.push(S[0]),h[v]=S}t({date:c,interpolate:e})},w=function(n){return null!==n&&void 0!==n},g=function(n,t){return n-t*Math.floor(n/t)},S=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},W=function(n,t,e,i,o,a,r,s){var l=r[0]*a,d=r[1]*a,u=y(n,t,e,i,o,s);return r[0]=u[0]*l+u[2]*d,r[1]=u[1]*l+u[3]*d,r},y=function(n,t,e,i,o,a){var r=2*Math.PI,s=Math.pow(10,-5.2),l=t<0?s:-s,d=e<0?s:-s,u=C(e,t+l,a),c=C(e+d,t,a),h=Math.cos(e/360*r);return[(u[0]-i)/l/h,(u[1]-o)/l/h,(c[0]-i)/d,(c[1]-o)/d]},M=null,H=function(n,t,e){function i(t,e){if(!n)return[NaN,NaN,null];var i=n[Math.round(t)];return i&&i[Math.round(e)]||h}n?M=n:n=M,i.release=function(){n=[]},i.randomize=function(n){var e,o,a=0;do e=Math.round(Math.floor(Math.random()*t.width)+t.x),o=Math.round(Math.floor(Math.random()*t.height)+t.y);while(null===i(e,o)[2]&&a++<30);return n.x=e,n.y=o,n},e(t,i)},J=function(n,t,e){var i=n[0],o=n[1],a=Math.round(i[0]),r=Math.max(Math.floor(i[1],0),0),s=(Math.min(Math.ceil(o[0],t),t-1),Math.min(Math.ceil(o[1],e),e-1));return{x:a,y:r,xMax:t,yMax:s,width:t,height:e}},_=function(n){return n/180*Math.PI},x=function(n){return n/(Math.PI/180)},L=function(n,t,e){var i=e.east-e.west,o=e.width/x(i)*360/(2*Math.PI),a=o/2*Math.log((1+Math.sin(e.south))/(1-Math.sin(e.south))),r=e.height+a,s=(r-t)/o,l=180/Math.PI*(2*Math.atan(Math.exp(s))-Math.PI/2),d=x(e.west)+n/e.width*x(i);return[d,l]},b=function(n){return Math.log(Math.tan(n/2+Math.PI/4))},C=function(n,t,e){var i=b(e.south),o=b(e.north),a=e.width/(e.east-e.west),r=e.height/(o-i),s=b(_(n)),l=(_(t)-e.west)*a,s=(o-s)*r;return[l,s]},P=function(n,t,e,o){function a(i){for(var o=[],a=t.y;a<=t.yMax;a+=2){var s=L(i,a,e);if(s){var u=s[0],c=s[1];if(isFinite(u)){var h=n.interpolate(u,c);h&&(h=W(r,u,c,i,a,l,h,e),o[a+1]=o[a]=h)}}}d[i+1]=d[i]=o}for(var r={},s=(e.south-e.north)*(e.west-e.east),l=i*Math.pow(s,.3),d=[],u=t.x;u<t.width;u+=2)a(u);H(d,t,o)},z=function(i,u,h){function p(n,t){var e=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"];return e.indexFor=function(i){return Math.max(0,Math.min(e.length-1,Math.round((i-n)/(t-n)*(e.length-1))))},e}function m(){w.forEach(function(n){n.length=0}),t.forEach(function(n){n.age>r&&(u.randomize(n).age=~~(Math.random()*r/2));var t=n.x,e=n.y,i=u(t,e),o=i[2];if(null===o)n.age=r;else{var a=t+i[0],s=e+i[1];null!==u(a,s)[0]?(n.xt=a,n.yt=s,w[v.indexFor(o)].push(n)):(n.x=a,n.y=s)}n.age+=1})}function f(){M.save(),M.globalAlpha=.16,M.globalCompositeOperation="destination-out",M.fillStyle="#000",M.fillRect(i.x,i.y,i.width,i.height),M.restore(),w.forEach(function(n,t){n.length>0&&(M.beginPath(),M.strokeStyle=v[t],n.forEach(function(n){M.moveTo(n.x,n.y),M.lineTo(n.xt,n.yt),n.x=n.xt,n.y=n.yt}),M.stroke())})}var v=p(o,a),w=v.map(function(){return[]}),g=(h.south-h.north)*(h.west-h.east),W=Math.round(i.width*i.height*l*Math.pow(g,.24));S()&&(W/=d),t=t||[],t.length>W&&(t=t.slice(0,W));for(var y=t.length;y<W;y++)t.push(u.randomize({age:~~(Math.random()*r)+0}));var M=n.canvas.getContext("2d");M.lineWidth=s;var H=Date.now();!function J(){e=requestAnimationFrame(J);var n=Date.now(),t=n-H;t>c&&(H=n-t%c,m(),f())}()},D=function(t,e,i,o,a){delete n.data,n.data=t,a&&F(e,i,o,a)},F=function(t,e,i,o){var a={south:_(o[0][1]),north:_(o[1][1]),east:_(o[1][0]),west:_(o[0][0]),width:e,height:i};O(),v(n.data,function(n){P(n,J(t,e,i),a,function(n,t){A.field=t,z(n,t,a)})})},O=function(){A.field&&A.field.release(),e&&cancelAnimationFrame(e)},T=function(e,i){var o=n.canvas,a=o.width,r=o.height,s=o.getContext("2d");if(a>e&&r>i){var l=function(n,t){return Math.max(0,Math.min(n,t))},d=s.getImageData(l(a,-e),l(r,-i),l(a,a-e),l(r,r-i));s.clearRect(0,0,a,r),s.putImageData(d,l(a,e),l(r,i));for(var u=0,c=t.length;u<c;u++)t[u].x+=e,t[u].y+=i}},A={params:n,start:F,stop:O,update:D,shift:T,createField:H};return A};window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){return window.setTimeout(n,1e3/FRAME_RATE)}}(),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(n){clearTimeout(n)}),L.Control.WindPosition=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable"},onAdd:function(n){return this._container=L.DomUtil.create("div","leaflet-control-wind-position"),L.DomEvent.disableClickPropagation(this._container),n.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(n){n.off("mousemove",this._onMouseMove,this)},vectorToSpeed:function(n,t){var e=Math.sqrt(Math.pow(n,2)+Math.pow(t,2));return e},vectorToDegrees:function(n,t){var e=Math.sqrt(Math.pow(n,2)+Math.pow(t,2)),i=Math.atan2(n/e,t/e),o=180*i/Math.PI,a=o+180;return a.toFixed(3)},_onMouseMove:function(n){var t=this,e=WindJSHelper.map.getSize(),i={width:e.x,height:e.y,x:n.containerPoint.x,y:n.containerPoint.y};WindJSHelper.windy.createField(null,i,function(e,i){var o=i(n.containerPoint.x,n.containerPoint.y),a="";if(o&&!isNaN(o[0])&&!isNaN(o[1])&&o[2]){var r=o[1];r=r>0?r-=2*r:Math.abs(r),a="<strong>Wind Direction: </strong>"+t.vectorToDegrees(o[0],r)+"°, <strong>Wind Speed: </strong>"+t.vectorToSpeed(o[0],r).toFixed(1)+"m/s, <strong>Temp: </strong>"+(o[2]-273.15).toFixed(1)+"°C"}else a="no wind data";t._container.innerHTML=a}),0==$(".leaflet-control-wind-position").index()&&$(".leaflet-control-wind-position").insertAfter(".leaflet-control-mouseposition")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.windPosition=function(n){return new L.Control.WindPosition(n)};var WindJSHelper={map:null,data:null,options:null,canvasOverlay:null,windy:null,context:null,timer:null,mouseControl:null,init:function(n){this.map=n.map,this.options=n,n.map.on("overlayremove",function(n){n.layer==WindJSHelper.canvasOverlay&&WindJSHelper.destroyWind()})},getRequestUrl:function(){if(!WindJSHelper.options.useNearest)return WindJSHelper.options.latestUrl;var n={timeIso:WindJSHelper.options.timeISO||(new Date).toISOString(),searchLimit:WindJSHelper.options.nearestDaysLimit||7};return WindJSHelper.options.nearestUrl+$.param(n)},loadLocalData:function(){console.log("using local data.."),$.getJSON("demo.json",function(n){WindJSHelper.data=n,WindJSHelper.initWindy(n)})},loadWindData:function(){if(WindJSHelper.options.localMode)return void WindJSHelper.loadLocalData();var n=WindJSHelper.getRequestUrl();console.log(n),$.ajax({type:"GET",url:n,data:{format:"json"},error:function(n){console.log("error loading data"),WindJSHelper.options.errorCallback(n)||console.log(n),WindJSHelper.loadLocalData()},success:function(n){WindJSHelper.data=n,WindJSHelper.initWindy(n)}})},redraw:function(n,t){return WindJSHelper.windy?(WindJSHelper.timer&&clearTimeout(WindJSHelper.timer),void(WindJSHelper.timer=setTimeout(function(){var n=WindJSHelper.map.getBounds(),t=WindJSHelper.map.getSize();WindJSHelper.windy.start([[0,0],[t.x,t.y]],t.x,t.y,[[n._southWest.lng,n._southWest.lat],[n._northEast.lng,n._northEast.lat]])},750))):void WindJSHelper.loadWindData()},initWindy:function(n){console.log(n),WindJSHelper.windy=new Windy({canvas:WindJSHelper.canvasOverlay.canvas(),data:n}),WindJSHelper.context=WindJSHelper.canvasOverlay.canvas().getContext("2d"),WindJSHelper.canvasOverlay.canvas().classList.add("wind-overlay"),WindJSHelper.canvasOverlay.redraw(),WindJSHelper.map.on("dragstart",WindJSHelper.windy.stop),WindJSHelper.map.on("zoomstart",WindJSHelper.clearWind),WindJSHelper.map.on("resize",WindJSHelper.clearWind),this.initMouseHandler()},initMouseHandler:function(){!WindJSHelper.mouseControl&&WindJSHelper.options.displayValues&&(WindJSHelper.mouseControl=L.control.windPosition(WindJSHelper.displayOptions||{}).addTo(WindJSHelper.map))},clearWind:function(){WindJSHelper.windy&&WindJSHelper.windy.stop(),WindJSHelper.context&&WindJSHelper.context.clearRect(0,0,3e3,3e3)},destroyWind:function(){WindJSHelper.timer&&clearTimeout(WindJSHelper.timer),WindJSHelper.windy&&WindJSHelper.windy.stop(),WindJSHelper.context&&WindJSHelper.context.clearRect(0,0,3e3,3e3),WindJSHelper.mouseControl&&WindJSHelper.map.removeControl(WindJSHelper.mouseControl),WindJSHelper.mouseControl=null,WindJSHelper.windy=null,WindJSHelper.map.removeLayer(WindJSHelper.canvasOverlay)}};WindJSHelper.canvasOverlay=L.canvasOverlay().drawing(WindJSHelper.redraw);var WindJSLeaflet=function(n){function t(n){return new Promise(function(t,e){n.localMode&&t(!0),$.ajax({type:"GET",url:n.pingUrl,data:{format:"json"},error:function(n){e(n)},success:function(n){t(n)}})})}t(n).then(function(){console.log("check wind success"),WindJSHelper.init(n),n.layerControl.addOverlay(WindJSHelper.canvasOverlay,"wind")})["catch"](function(t){console.log("check wind failed.."),n.errorCallback(t)})};WindJSLeaflet.prototype.setTime=function(n){WindJSHelper.options.timeISO=n};