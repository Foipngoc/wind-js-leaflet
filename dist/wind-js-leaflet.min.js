"use strict";function _defineProperty(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_L$Class$extend;L.CanvasOverlay=L.Class.extend((_L$Class$extend={initialize:function(t,n){this._userDrawFunc=t,L.setOptions(this,n)},drawing:function(t){return this._userDrawFunc=t,this},params:function(t){return L.setOptions(this,t),this},canvas:function(){return this._canvas},_redraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer");var n=this._map.getSize();this._canvas.width=n.x,this._canvas.height=n.y;var e=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(e?"animated":"hide")),t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.on("resize",this._resize,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.off("resize",this._resize,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_resize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t),this._redraw()}},_defineProperty(_L$Class$extend,"_redraw",function(){var t=this._map.getSize(),n=this._map.getBounds(),e=180*t.x/(20037508.34*(n.getEast()-n.getWest())),o=this._map.getZoom();this._userDrawFunc&&this._userDrawFunc(this,{canvas:this._canvas,bounds:n,size:t,zoomScale:e,zoom:o,options:this.options}),this._frame=null}),_defineProperty(_L$Class$extend,"_animateZoom",function(t){var n=this._map.getZoomScale(t.zoom),e=this._map._getCenterOffset(t.center)._multiplyBy(-n).subtract(this._map._getMapPanePos());this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(e)+" scale("+n+")"}),_L$Class$extend)),L.canvasOverlay=function(t,n){return new L.CanvasOverlay(t,n)};var Windy=function(t){var n,e,o,i,a,r,s,l,u,h,c,d=.005*(Math.pow(window.devicePixelRatio,1/3)||1),f=261.15,m=317.15,_=90,p=1,v=.005,w=Math.pow(window.devicePixelRatio,1/3)||1.6,y=15,g=1e3/y,M=[NaN,NaN,null],x=function(t,n,e,o,i,a){var r=1-t,s=1-n,l=r*s,u=t*s,h=r*n,c=t*n,d=e[0]*l+o[0]*u+i[0]*h+a[0]*c,f=e[1]*l+o[1]*u+i[1]*h+a[1]*c,m=e[2]*l+o[2]*u+i[2]*h+a[2]*c;return[d,f,m]},b=function(t,n,e){var o=t.data,i=n.data;return{header:t.header,data:function(t){return[o[t],i[t],e.data[t]]},interpolate:x}},L=function(t){var n=null,e=null,o=null,i=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":n=t;break;case"2,3":e=t;break;case"0,0":o=t;break;default:i=t}}),b(n,e,o)},C=function(t,h){n=L(t);var c=n.header;i=c.lo1,a=c.la1,r=c.dx,s=c.dy,l=c.nx,u=c.ny,o=new Date(c.refTime),o.setHours(o.getHours()+c.forecastTime),e=[];for(var d=0,f=Math.floor(l*r)>=360,m=0;m<u;m++){for(var _=[],p=0;p<l;p++,d++)_[p]=n.data(d);f&&_.push(_[0]),e[m]=_}h({date:o,interpolate:P})},P=function(t,o){if(!e)return null;var l,u=z(t-i,360)/r,h=(a-o)/s,c=Math.floor(u),d=c+1,f=Math.floor(h),m=f+1;if(l=e[f]){var _=l[c],p=l[d];if(S(_)&&S(p)&&(l=e[m])){var v=l[c],w=l[d];if(S(v)&&S(w))return n.interpolate(u-c,h-f,_,p,v,w)}}return null},S=function(t){return null!==t&&void 0!==t},z=function(t,n){return t-n*Math.floor(t/n)},D=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},O=function(t,n,e,o,i,a,r,s){var l=r[0]*a,u=r[1]*a,h=T(t,n,e,o,i,s);return r[0]=h[0]*l+h[2]*u,r[1]=h[1]*l+h[3]*u,r},T=function(t,n,e,o,i,a){var r=2*Math.PI,s=Math.pow(10,-5.2),l=n<0?s:-s,u=e<0?s:-s,h=I(e,n+l,a),c=I(e+u,n,a),d=Math.cos(e/360*r);return[(h[0]-o)/l/d,(h[1]-i)/l/d,(c[0]-o)/u,(c[1]-i)/u]},W=function(t,n,e){function o(n,e){if(!t)return[NaN,NaN,null];var o=t[Math.round(n)];return o&&o[Math.round(e)]||M}o.release=function(){t=[]},o.randomize=function(t){var e,i,a=0;do e=Math.round(Math.floor(Math.random()*n.width)+n.x),i=Math.round(Math.floor(Math.random()*n.height)+n.y);while(null===o(e,i)[2]&&a++<30);return t.x=e,t.y=i,t},e(n,o)},F=function(t,n,e){var o=t[0],i=t[1],a=Math.round(o[0]),r=Math.max(Math.floor(o[1],0),0),s=(Math.min(Math.ceil(i[0],n),n-1),Math.min(Math.ceil(i[1],e),e-1));return{x:a,y:r,xMax:n,yMax:s,width:n,height:e}},A=function(t){return t/180*Math.PI},R=function(t){return t/(Math.PI/180)},N=function(t,n,e){var o=e.east-e.west,i=e.width/R(o)*360/(2*Math.PI),a=i/2*Math.log((1+Math.sin(e.south))/(1-Math.sin(e.south))),r=e.height+a,s=(r-n)/i,l=180/Math.PI*(2*Math.atan(Math.exp(s))-Math.PI/2),u=R(e.west)+t/e.width*R(o);return[u,l]},$=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},I=function(t,n,e){var o=$(e.south),i=$(e.north),a=e.width/(e.east-e.west),r=e.height/(i-o),s=$(A(t)),l=(A(n)-e.west)*a,s=(i-s)*r;return[l,s]},E=function(t,n,e,o){function i(o){for(var i=[],r=n.y;r<=n.yMax;r+=2){var u=N(o,r,e);if(u){var h=u[0],c=u[1];if(isFinite(h)){var d=t.interpolate(h,c);d&&(d=O(a,h,c,o,r,s,d,e),i[r+1]=i[r]=d)}}}l[o+1]=l[o]=i}for(var a={},r=(e.south-e.north)*(e.west-e.east),s=d*Math.pow(r,.3),l=[],u=n.x;u<n.width;u+=2)i(u);W(l,n,o)},k=function(n,e,o){function i(t,n){var e=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"];return e.indexFor=function(o){return Math.max(0,Math.min(e.length-1,Math.round((o-t)/(n-t)*(e.length-1))))},e}function a(){l.forEach(function(t){t.length=0}),h.forEach(function(t){t.age>_&&(e.randomize(t).age=~~(Math.random()*_/2));var n=t.x,o=t.y,i=e(n,o),a=i[2];if(null===a)t.age=_;else{var r=n+i[0],u=o+i[1];null!==e(r,u)[0]?(t.xt=r,t.yt=u,l[s.indexFor(a)].push(t)):(t.x=r,t.y=u)}t.age+=1})}function r(){M.save(),M.globalAlpha=.16,M.globalCompositeOperation="destination-out",M.fillStyle="#000",M.fillRect(n.x,n.y,n.width,n.height),M.restore(),l.forEach(function(t,n){t.length>0&&(M.beginPath(),M.strokeStyle=s[n],t.forEach(function(t){M.moveTo(t.x,t.y),M.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),M.stroke())})}var s=i(f,m),l=s.map(function(){return[]}),u=(o.south-o.north)*(o.west-o.east),d=Math.round(n.width*n.height*v*Math.pow(u,.24));D()&&(d/=w),h=h||[],h.length>d&&(h=h.slice(0,d));for(var y=h.length;y<d;y++)h.push(e.randomize({age:~~(Math.random()*_)+0}));var M=t.canvas.getContext("2d");M.lineWidth=p;var x=Date.now();!function b(){c=requestAnimationFrame(b);var t=Date.now(),n=t-x;n>g&&(x=t-n%g,a(),r())}()},q=function(n,e,o,i,a){delete t.data,t.data=n,a&&U(e,o,i,a)},U=function(n,e,o,i){var a={south:A(i[0][1]),north:A(i[1][1]),east:A(i[1][0]),west:A(i[0][0]),width:e,height:o};H(),C(t.data,function(t){E(t,F(n,e,o),a,function(t,n){B.field=n,k(t,n,a)})})},H=function(){B.field&&B.field.release(),c&&cancelAnimationFrame(c)},j=function(n,e){var o=t.canvas,i=o.width,a=o.height,r=o.getContext("2d");if(i>n&&a>e){var s=function(t,n){return Math.max(0,Math.min(t,n))},l=r.getImageData(s(i,-n),s(a,-e),s(i,i-n),s(a,a-e));r.clearRect(0,0,i,a),r.putImageData(l,s(i,n),s(a,e));for(var u=0,c=h.length;u<c;u++)h[u].x+=n,h[u].y+=e}},B={params:t,start:U,stop:H,update:q,shift:j,createField:W,interpolatePoint:P};return B};window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/FRAME_RATE)}}(),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),L.Control.WindPosition=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable"},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-wind-position"),L.DomEvent.disableClickPropagation(this._container),t.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(t){t.off("mousemove",this._onMouseMove,this)},vectorToSpeed:function(t,n){var e=Math.sqrt(Math.pow(t,2)+Math.pow(n,2));return e},vectorToDegrees:function(t,n){var e=Math.sqrt(Math.pow(t,2)+Math.pow(n,2)),o=Math.atan2(t/e,n/e),i=180*o/Math.PI,a=i+180;return a.toFixed(3)},_onMouseMove:function(t){var n=this,e=WindJSLeaflet._map.containerPointToLatLng(L.point(t.containerPoint.x,t.containerPoint.y)),o=WindJSLeaflet._windy.interpolatePoint(e.lng,e.lat),i="";if(o&&!isNaN(o[0])&&!isNaN(o[1])&&o[2]){var a=o[1];a=a>0?a-=2*a:Math.abs(a),i="<strong>Wind Direction: </strong>"+n.vectorToDegrees(o[0],a)+"°, <strong>Wind Speed: </strong>"+n.vectorToSpeed(o[0],a).toFixed(1)+"m/s, <strong>Temp: </strong>"+(o[2]-273.15).toFixed(1)+"°C"}else i="no wind data";n._container.innerHTML=i,0==$(".leaflet-control-wind-position").index()&&$(".leaflet-control-wind-position").insertAfter(".leaflet-control-mouseposition")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.windPosition=function(t){return new L.Control.WindPosition(t)},function(t,n){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=n(require("wind-js-leaflet")):"function"==typeof define&&define.amd?define(["wind-js-leaflet"],function(e){return t.returnExportsGlobal=n(window)}):window.WindJSLeaflet=n(window)}(void 0,function(t){var n={_map:null,_data:null,_options:null,_canvasOverlay:null,_windy:null,_context:null,_timer:0,_mouseControl:null,init:function(t){this._checkWind(t).then(function(){n._map=t.map,n._options=t,n._canvasOverlay=L.canvasOverlay().drawing(n._redraw),n._options.layerControl.addOverlay(n._canvasOverlay,"wind"),n._map.on("overlayremove",function(t){t.layer==n.__canvasOverlay&&WindJSHelper._destroyWind()})})["catch"](function(t){n._options.errorCallback(t)})},setTime:function(t){n._options.timeISO=t},_checkWind:function(t){return new Promise(function(n,e){t.localMode&&n(!0),$.ajax({type:"GET",url:t.pingUrl,error:function(t){e(t)},success:function(t){n(t)}})})},_getRequestUrl:function(){if(!this._options.useNearest)return this._options.latestUrl;var t={timeIso:this._options.timeISO||(new Date).toISOString(),searchLimit:this._options.nearestDaysLimit||7};return this._options.nearestUrl+"?"+$.param(t)},_loadLocalData:function(){console.log("using local data.."),$.getJSON("demo.json",function(t){n._data=t,n._initWindy(t)})},_loadWindData:function(){if(this._options.localMode)return void this._loadLocalData();var t=this._getRequestUrl();console.log(t),$.ajax({type:"GET",url:t,error:function(t){console.log("error loading data"),n._options.errorCallback(t)||console.log(t),n._loadLocalData()},success:function(t){n._data=t,n._initWindy(t)}})},_redraw:function(t,e){return n._windy?(this._timer&&clearTimeout(n._timer),void(this._timer=setTimeout(function(){var t=n._map.getBounds(),e=n._map.getSize();n._windy.start([[0,0],[e.x,e.y]],e.x,e.y,[[t._southWest.lng,t._southWest.lat],[t._northEast.lng,t._northEast.lat]])},750))):void n._loadWindData()},_initWindy:function(t){console.log(t),this._windy=new Windy({canvas:n._canvasOverlay._canvas,data:t}),this._context=this._canvasOverlay._canvas.getContext("2d"),this._canvasOverlay._canvas.classList.add("wind-overlay"),this._canvasOverlay._redraw(),this._map.on("dragstart",n._windy.stop),this._map.on("zoomstart",n._clearWind),this._map.on("resize",n._clearWind),this._initMouseHandler()},_initMouseHandler:function(){!this._mouseControl&&this._options.displayValues&&(this._mouseControl=L.control.windPosition(this._options.displayOptions||{}).addTo(this._map))},_clearWind:function(){this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3)},_destroyWind:function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._mouseControl&&this.map.removeControl(this._mouseControl),this._mouseControl=null,this._windy=null,this._map.removeLayer(this._canvasOverlay)}};return n});